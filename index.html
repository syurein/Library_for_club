<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>電工部蔵書管理サイト</title>
    
  </head>
  <body>
    <style>
      
      h1{
        background-color: aquamarine;
      }
      table{
        background-color: blanchedalmond;
      }
      body{
        background-color: rgb(5, 247, 122);
      }
      
      .cant{
        background-color: crimson;
      }
    </style>
    <h1>電工部蔵書サイト</h1>
    <input type='input' id="keyword">
    <input type="button" value="search!" onclick="search_book()">
    <button onclick="get_data()">Reset!</button>
    <table border="1">
      
      <thead>
        <tr>

        <th>No.</th>
        <th>タイトル</th>
        <th>貸出中/利用可</th>
        <th>貸出者名</th>
        <th>ボタン</th>
        </tr>
      </thead>
      <tbody id="book_table">
        
      </tbody>
    </table>
    
    
    <script>
    window.onload=()=>{
      get_data();
    }
    let count_num=0;
    class Book_Info{
      constructor(num,title,status,name){
        this.num=num;
        this.title=title;
        this.status=status;
        this.name=name;
      }
    }
    
    function add_books(books){
      let counter=0;
      if(books){
        
        let book;
        let title=Array.from(Object.keys(books??{}))
        console.log(books)
        console.log(Object.keys(books))
        const tables=document.getElementById('book_table');
        console.log(tables.childElementCount)
       
        while (tables.firstChild) {
          tables.removeChild(tables.firstChild);
        }
                
        while(title.length>counter){
          book=books[title[counter]]
          let table_chiled=document.createElement('tr');
          table_chiled.innerHTML=`<td>${counter}</td><td>${title[counter]}</td><td>${function(){ if(book.status==0){return '<div class="can">〇</div>'}else{return '<div class="cant">X</div>'}}()}</td><td>${book.name}</td><td>${function(){if(book.status==0){return `<button onclick="borrow_books('${title[counter]}')">借りる</button>`}else{return `<button onclick="return_books('${title[counter]}')">返す</button>`}}()}</td>`
          tables.appendChild(table_chiled);
          counter++;
          
        }
        counter=0
      }
    }
    function get_data(){
      console.log(1)
      const xhr=new XMLHttpRequest();
      let data;
      xhr.open("GET","/get_data");
      xhr.send();
      xhr.responseType='json';
      //onloadイベントをキャッチしてる
      xhr.onload=()=>{
        if (xhr.readyState==4&&xhr.status==200){
          data=xhr.response;
          //console.log(data)
          add_books(data)
        }else{
          console.log(`Error:${xhr.status}`);
        }
      }
    //クライアントの状態が4（DONE）で、ステータスコードが200（成功）であれば、
    // コンソールにデータが記録されます。そうでない場合は、エラー状況を示すエラーメッセージが表示されます。
      add_books(data)
    }





    function set_data(){
      title=document.getElementById('input_title')
      console.log(title.value)
      status=1
      const xhr=new XMLHttpRequest();
      xhr.open('POST','./set_data');
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      const body =JSON.stringify({
        title:`${title.value}`,
        status:1
      })
      xhr.onload =()=>{
         if (xhr.readyState == 4 && xhr.status == 200) {
            console.log(JSON.parse(xhr.responseText));
          } else {
            console.log(`Error: ${xhr.status}`);
          }
      }
      xhr.send(body)
    }
   /* setInterval(() => {
    get_data();
  }, 3000);*/
    function borrow_books(title,name='hikari'){
      name=prompt('借りる人の名前を入力してください')
      if (!name)name='Unknown'
      console.log(title)
      status=1
      const xhr=new XMLHttpRequest();
      xhr.open('POST','./set_borrow');
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      const body =JSON.stringify({
        title:`${title}`,
        status:1,
        name:name
      })
      xhr.onload =()=>{
         if (xhr.readyState == 4 && xhr.status == 200) {
          get_data()
            //console.log(JSON.parse(xhr.responseText));
          } else {
            console.log(`Error: ${xhr.status}`);
            get_data()
          }
      }
      xhr.send(body)
      get_data()
    }


function return_books(title){
      status=1
      const xhr=new XMLHttpRequest();
      xhr.open('POST','./set_data');
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      const body =JSON.stringify({
        title:`${title}`,
        status:0,
        name:'None'
      })
      xhr.onload =()=>{
         if (xhr.readyState == 4 && xhr.status == 200) {
            //console.log(JSON.parse(xhr.responseText));
            get_data()
          } else {
            console.log(`Error: ${xhr.status}`);
            get_data()
          }
      }
      xhr.send(body)
      get_data()
    }


    function search_book(){
      keyword=document.getElementById('keyword');
      const xhr=new XMLHttpRequest();
      let data;
      xhr.open("GET",`/search_data/${keyword.value}`);
      xhr.send();
      keyword.value=''
      xhr.responseType='json';
      //onloadイベントをキャッチしてる
      xhr.onload=()=>{
        if (xhr.readyState==4&&xhr.status==200){
          data=xhr.response;
          //console.log(data)
          add_books(data)
        }else{
          console.log(`Error:${xhr.status}`);
        }
      }
    //クライアントの状態が4（DONE）で、ステータスコードが200（成功）であれば、
    // コンソールにデータが記録されます。そうでない場合は、エラー状況を示すエラーメッセージが表示されます。
      add_books(data)
    }
    



    
    </script>
  </body>
</html>